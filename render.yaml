services:
  - type: web
    name: creditapp
    env: php
    
    # 1. Commande de CONSTRUCTION (Build Command)
    # Ce script est exécuté UNE SEULE FOIS pour préparer le code.
    buildCommand: |
      # 1. Installer les dépendances (OBLIGATOIRE !)
      composer install --prefer-dist --no-dev --no-progress
      
      # 2. Lier le dossier public pour les assets
      php artisan storage:link --force
      
      # 3. Exécuter les migrations
      php artisan migrate --force
      
      # 4. Nettoyer et optimiser le cache Laravel
      php artisan optimize:clear
      
    # 2. Commande de DÉMARRAGE (Start Command)
    # Cette commande est exécutée à chaque fois que le serveur démarre.
    startCommand: vendor/bin/heroku-php-apache2 public/
    
    # 3. Disque Persistant (RECOMMANDÉ pour le dossier 'storage')
    # Ceci garantit que les sessions, logs, et fichiers uploadés ne sont pas perdus.
    disk:
      name: storage-disk
      mountPath: /var/www/html/storage
      
    # 4. Variables d'Environnement
    envVars:
      - key: APP_NAME
        value: CréditApp
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: 'false'
      
      # Clé d'application : Remplacer votre clé codée en dur par cette instruction.
      # Render générera une clé sécurisée pour vous.
      - key: APP_KEY
        generateValue: true

      # Variables de Connexion à la Base de Données
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        value: votre-host-render # Renseignez ici le HOST de votre base de données Render
      - key: DB_PORT
        value: 3306
      - key: DB_DATABASE
        value: votre_nom_de_base
      - key: DB_USERNAME
        value: votre_user
      - key: DB_PASSWORD
        value: votre_password
        
      # Configuration du Cache/Session (Recommandé en prod)
      - key: SESSION_DRIVER
        value: file # Utiliser 'file' car le dossier 'storage' est persistant
      - key: CACHE_DRIVER
        value: file
      - key: QUEUE_CONNECTION
        value: sync # ou database/redis si configuré